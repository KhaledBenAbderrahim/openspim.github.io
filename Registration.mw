= Bead Based Registration =

The first step in the SPIMage processing pipeline, after [[Pre-processing|re-saving the ome.tiffs as .tif]], is to '''register''' the views within each timepoint. We will use for that the [http://fiji.sc/SPIM_Registration ''bead based registration''] plug-in in Fiji. The principles of the plug-in are described on the Fiji wiki page [http://fiji.sc/SPIM_Registration_Method SPIM registration method] while the parameters are discussed in [http://fiji.sc/SPIM_Bead_Registration SPIM bead registration]. Here we present a step by step recipe for performing the bead based registration on OpenSPIM data.

== Input ==

{|
|-
|[[File:Spim plugin menu.jpg|thumb|400px|right|Screenshot of SPIM registration section of Fiji plugin menu]]
First we start the plugin from '''Plugins->SPIM Registration->Bead based registration''' (or pressing letter '''l''' and typing SPIM etc.).


''Note that all SPIM related plugins are conveniently grouped in the plugins submenu SPIM Registration. Later on we will see how to use [[Fusion|Multi-view fusion]] to combine registered views into single output image and [[Fusion#deconvolution|Multi-view Deconvolution]] for deconvolution mediated fusion which enhances image contrast and in some cases improves resolution. The plugins are linked to each other and share many parameters. I.e. if we first run registration and select the appropriate directories with data, these fields will be pre-filled for fusion unless, of course, we have restarted Fiji in the meantime.   
 
|-
|
----[[File:Registration screen1.jpg|thumb|400px|right|Screenshot of the first dialog of the bead based registration plugin]]
In the following window we choose '''Single channel''' registration and select between two methods of localising the beads. '''Difference-of-Gaussian''' ([http://en.wikipedia.org/wiki/Blob_detection DoG]) is more precise however slower compared to '''Difference of Mean''' which takes advantage of [http://fiji.sc/Integral_Image_Filters integral images]. 


In most cases '''Difference of Mean''' will be sufficient for registration of OpenSPIM data and so we will choose this option.


Click '''OK''' to continue to the second dialog.
|-
|
----[[File:Registration screen2.jpg|thumb|400px|right|Screenshot of second dialog of the bead based registration plugin]]
In the top part of the dialog we will point the plugin to where the data reside and define the naming scheme of the files.


Click '''Browse''' to locate the directory with the ''.tif'' files generated in the [[Pre-processing|previous]] step of the pipeline.


Enter the pattern of the files, where '''tt''' is a zero padded place holder for timepoints and '''a''' a zero padded placeholder for angles/views. If we have a three digit series (000 - 100) we use '''{ttt}'''; in case of our sample data that range from 0 to 10 we need '''tt''' as timepoint placeholder. 

''Importantly, do not forget to adjust the extension to .tif. This is a common mistake at the default extension is for historical reason .lsm - a format used to store data from the Zeiss SPIM demonstrator.''


We will initially optimize the registration using timepoint '''5'''. To register all time-points in the timeseries we would enter '''0-10'''. The range does not need to start with 0 or 1. Discontinuous series is also possible, for example '''1,5,10'''.


Finally we specify the '''Angles to process''', in our case '''0-4''' (0.1.2.3.4 = 5 angles). Any comma separated list will do, for instance '''60,180, 235'''.


In the second section of the dialog we need to initially pay attention only to the parameters affecting the initial segmentation of the bead. '''Bead Brightness''' is a pull down menu offering 6 options.


* ''Very weak'' - the threshold for bead detection set to 0.02 (typically when the beads emit in a different wavelength compared to sample, i.e. red green beads for red fluorescent sample)
* ''Weak'' - the threshold for bead detection set to 0.02
* ''Comparable to sample'' - the threshold for bead detection set to 0.02 (typically when using beads emitting in the same wavelength as the sample, i.e. green beads and GFP in the sample)
* ''Strong'' - the threshold for bead detection set to 0.02
* ''Advanced'' - the threshold for bead detection can be set manually in the following dialog
* ''Interactive'' - the threshold can be manually adjusted based on visualization of bead detection on a user selected timepoint


In out initial run we will select the option '''Interactive''' to play around with the threshold that is best suited for our data.


The '''Subpixel localization''' is a pull down menu offering three option for more-or-less precisely localising the beads


* ''3-dimensional quadratic fit (all detections)'' - fastest, but least precise option, sufficient for OpenSPIM data
* ''Gauss-fit (true correspondances)'' - more precise but slower, limited only to true correspondances for performance reasons.
* ''Gauss-fit (all detections)'' - the slowest option where Gauss fitting is applied to all bead detections which can be many and it can take a while.

We will select '''3-dimensional quadratic fit''' for our sample OpenSPIM data.


For OpenSPIM data it is very importnat to select the '''Specify calibration manually''' checkbox and enter the '''xy''' and '''z''' resolution. For the sample OpenSPIM data discussed here the following parameters work.


* ''xy resolution (um/px)'' = '''0.645''' - this is dictated by the optics of the detection path of OpenSPIM and the size of the pixels on the CCD camera.
* ''z resolution (un/px)'' = '''6'''  - the step size of the motors on OpenSPIM are 1.5 um and we sued 4 z steps between planes when acquiring the sample data, i.e. 4 x 1.5 = 6 um.


''Note that the important number here is the ration between the z and xy resolutions. In the case of OpenSPIM sample data it is 6/0.645 = 9.3023. We could also express the ratio as xy = 1 and z = 9.3023. The 9.0323 or z-scaling is an important number to remember and write down. We will need it during all subsequent steps.''


Finally we will examine the pull down menu '''Transformation model''' that offer three options

* ''Translation'' - uses transformation model that takes into account only translation between views (nto particularly useful for multi-view OpenSPIM data).
* ''Rigid'' - included additionally rotation
* ''Affine'' - includes scaling and shearing (necessary for OpenSPIM data due to aberrations introduced by difraction index mismatch between water and agarose).


We will leave '''Affine''' as a useful and, in fact, necessary default for OpenSPIM data.

That's it, we can for now safely ignore the remaining options of the dialog and proceed by clicking '''OK'''.
|-
|
----[[File:Screenshot-Select view to analyze.png|thumb|400px|right|Dialog for selection of data file (view) for Interactive bead segmentation.]]
Since we have selected the '''Bead brightness->Interactive''' the next dialog will ask us to select a time-point to perform the segmentation optimization on. Click '''Browse''' and locate the file ''spim_TL05_Angle0.tif'' and then press '''OK'''.
|-
|
----
[[File:Interactive segmentation.png|thumb|400px|right|Desktop showing windows opened during interactive segmentation.]]
After a short delay two windows will pop-up. In the browseable '''stack window''' the view selected in the previous step is shown and beads segmented using the current parameters are highlighted with small green circles. The parameters can be interactively changed in the '''Adjust Difference-of-Mean Values''' window. 


Typically we only need to play with the '''Threshold'''. The lower the threshold the more 'beads' are segmented. The goal here is to find a threshold where most beads are detected - ideally only once. We can examine the performance of a particular threshold by browsing through the stack and zooming in and out using the Fiji toolbar tools. We want to avoid the situation where several detections are shown for what appears to be a single bead and conversely when clearly visible beads are not detected at all. You will notice that the detections (the green circles) are not limited to beads but occur also around the nuclei inside the sample. As we will see later, these detection are spurious, not repeatable between views, and do not compromise the registration process. The search for the optimal threshold can be made easier by adjusting the contrast of the stack to see the beads better (window in the lower left corner, press '''CTRL-SHIFT-C''' and click on '''Auto''').


''The threshold that works well for OpenSPIM sample data is '''0.01'''''


Once we identify a reasonable threshold we can click '''Done''' and start the registration process with the selected threshold.
|}

== Run ==


== Output ==
